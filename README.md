# FactorFramework - å› å­æŒ–æ˜ä¸ç®¡ç†ç³»ç»Ÿ

[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)

ä¸€ä¸ªè½»é‡çº§ã€æ¨¡å—åŒ–çš„é‡åŒ–å› å­ç ”ç©¶æ¡†æ¶ï¼Œä¸“æ³¨äº**å› å­æŒ–æ˜ã€è¯„ä»·å’Œç®¡ç†**çš„å®Œæ•´å·¥ä½œæµã€‚

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [å› å­æŒ–æ˜æµç¨‹](#å› å­æŒ–æ˜æµç¨‹)
  - [æ–¹å¼ä¸€ï¼šäº¤äº’å¼æŒ–å› å­ï¼ˆæ¨èï¼‰](#æ–¹å¼ä¸€äº¤äº’å¼æŒ–å› å­æ¨è)
  - [æ–¹å¼äºŒï¼šè‡ªåŠ¨æ‰¹é‡æŒ–å› å­](#æ–¹å¼äºŒè‡ªåŠ¨æ‰¹é‡æŒ–å› å­)
- [å› å­åº“ç®¡ç†](#å› å­åº“ç®¡ç†)
  - [æŸ¥çœ‹å› å­åº“](#æŸ¥çœ‹å› å­åº“)
  - [ä½¿ç”¨å·²å…¥åº“å› å­](#ä½¿ç”¨å·²å…¥åº“å› å­)
  - [åˆ é™¤å› å­](#åˆ é™¤å› å­)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [ä¾èµ–å®‰è£…](#ä¾èµ–å®‰è£…)

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ å®Œæ•´çš„å› å­æŒ–æ˜å·¥ä½œæµ
- **äº¤äº’å¼å› å­åˆ†æ**ï¼šåœ¨ Jupyter Notebook ä¸­å®æ—¶ç¼–å†™ã€æµ‹è¯•å’Œè¯„ä»·å› å­
- **å¤šå‘¨æœŸè¯„ä»·**ï¼šæ”¯æŒ 1æ—¥ã€5æ—¥ã€10æ—¥ã€20æ—¥ç­‰å¤šä¸ªæŒæœ‰æœŸçš„å› å­è¡¨ç°è¯„ä»·
- **è‡ªåŠ¨åŒ–å…¥åº“**ï¼šæ ¹æ®é¢„è®¾è§„åˆ™ï¼ˆICã€IRã€æ¢æ‰‹ç‡ç­‰ï¼‰è‡ªåŠ¨ç­›é€‰ä¼˜è´¨å› å­å…¥åº“
- **æ‰¹é‡å¤„ç†**ï¼šä¸€é”®æ‰¹é‡è¯„ä»·å’Œå…¥åº“å¤šä¸ªå€™é€‰å› å­

### ğŸ“Š ä¸°å¯Œçš„è¯„ä»·æŒ‡æ ‡
- **IC æŒ‡æ ‡**ï¼šIC å‡å€¼ã€æ ‡å‡†å·®ã€IRã€t ç»Ÿè®¡é‡
- **Rank IC æŒ‡æ ‡**ï¼šRank IC å‡å€¼ã€æ ‡å‡†å·®ã€IRã€t ç»Ÿè®¡é‡
- **æ”¶ç›ŠæŒ‡æ ‡**ï¼šåˆ†ç»„æ”¶ç›Šã€å¤šç©ºæ”¶ç›Šã€æ”¶ç›Šå•è°ƒæ€§
- **äº¤æ˜“æˆæœ¬**ï¼šTop 20% æ¢æ‰‹ç‡åˆ†æ
- **å¯è§†åŒ–å›¾è¡¨**ï¼šIC æ—¶åºå›¾ã€åˆ†ç»„ç´¯è®¡æ”¶ç›Šå›¾ã€å¤šç©ºæ”¶ç›Šå›¾ç­‰

### ğŸ—„ï¸ åŒå­˜å‚¨å› å­åº“
- **Manual Store**ï¼šæ‰‹åŠ¨ç²¾é€‰çš„é«˜è´¨é‡å› å­ï¼Œä¸æ£€æŸ¥è¯„ä»·æŒ‡æ ‡
- **Auto Store**ï¼šè‡ªåŠ¨ç­›é€‰çš„å› å­ï¼Œéœ€æ»¡è¶³å…¥åº“è§„åˆ™ï¼ˆICã€IR ç­‰é˜ˆå€¼ï¼‰
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒåŒä¸€å› å­çš„å¤šä¸ªç‰ˆæœ¬å…±å­˜

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install pandas numpy scipy matplotlib pyyaml ipywidgets
```

### 2. å‡†å¤‡æ•°æ®

å°†è¡Œæƒ…æ•°æ®æ”¾å…¥ `data/` ç›®å½•ï¼Œæ•°æ®æ ¼å¼è¦æ±‚ï¼š
- **ç´¢å¼•**ï¼šMultiIndex(date, code)
- **åˆ—**ï¼šè‡³å°‘åŒ…å« `close` åˆ—ï¼Œå¯é€‰ `open`, `high`, `low`, `volume`, `amount` ç­‰

ç¤ºä¾‹æ•°æ®ï¼š
```python
                        open    high     low   close    volume     amount
date       code                                                           
2020-01-01 000001.SZ  100.0  102.0    99.0   101.0  1000000.0  1.01e+08
           000002.SZ   50.0   51.0    49.5    50.5   500000.0  2.53e+07
```

### 3. é…ç½®å› å­åº“

ç¼–è¾‘ `config.yaml` é…ç½®æ–‡ä»¶ï¼š

```yaml
# å­˜å‚¨é…ç½®
storage:
  base_dir: "./factor_store"
  manual_dir: "manual"
  auto_dir: "auto"

# å…¥åº“è§„åˆ™
admission:
  min_rank_ic: 0.02              # æœ€å° Rank IC å‡å€¼
  min_rank_ic_ir: 0.4            # æœ€å° Rank IC IR
  max_top_turnover_20_mean: 0.6  # æœ€å¤§æ¢æ‰‹ç‡ï¼ˆç›¸å¯¹äºå‘¨æœŸï¼‰
  min_monotonic_mean: 0.1        # æœ€å°æ”¶ç›Šå•è°ƒæ€§
```

### 4. å¼€å§‹æŒ–å› å­

æ‰“å¼€ `analysis.ipynb` å¼€å§‹äº¤äº’å¼å› å­æŒ–æ˜ï¼Œæˆ–ä½¿ç”¨ `auto_batch.py` è¿›è¡Œæ‰¹é‡å¤„ç†ã€‚

---

## ğŸ” å› å­æŒ–æ˜æµç¨‹

### æ–¹å¼ä¸€ï¼šäº¤äº’å¼æŒ–å› å­ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `analysis.ipynb` è¿›è¡Œäº¤äº’å¼å› å­ç ”ç©¶ï¼Œé€‚åˆå¿«é€Ÿå®éªŒå’Œè°ƒè¯•ã€‚

#### æ­¥éª¤ 1ï¼šåŠ è½½æ•°æ®å’Œåˆå§‹åŒ–å¼•æ“

```python
import pandas as pd
import numpy as np
from data_manager import LoacalDatasource
from factor_engine import register_factor, FactorEngine
from evaluation.engine import EvaluatorEngine

# åŠ è½½æ•°æ®
datasource = LoacalDatasource(file_path="./data/daily_price.parquet")
df = datasource.load_data(start="2020-01-01", end="2026-01-01")

# åˆå§‹åŒ–å¼•æ“
factor_engine = FactorEngine()
evaluator_engine = EvaluatorEngine()
```

#### æ­¥éª¤ 2ï¼šå®šä¹‰å› å­

```python
factor_name = "my_momentum_factor"

@register_factor(
    name=factor_name,
    required_fields=["close"],
    version="v1"
)
def my_momentum_factor(df: pd.DataFrame) -> pd.Series:
    """
    è‡ªå®šä¹‰åŠ¨é‡å› å­
    
    å‚æ•°:
        df: MultiIndex(date, code) çš„ DataFrame
        
    è¿”å›:
        pd.Series: å› å­å€¼ï¼Œç´¢å¼•ä¸ df å¯¹é½
    """
    # ç¤ºä¾‹ï¼š20æ—¥æ”¶ç›Šç‡
    return df.groupby(level="code")["close"].pct_change(20)
```

**å› å­ç¼–å†™æ³¨æ„äº‹é¡¹**ï¼š
- è¾“å…¥ï¼š`df` çš„ç´¢å¼•å¿…é¡»æ˜¯ `MultiIndex(date, code)`
- è¾“å‡ºï¼šè¿”å›çš„ `Series` ç´¢å¼•å¿…é¡»ä¸ `df` å¯¹é½
- åˆ†ç»„è®¡ç®—ï¼šä½¿ç”¨ `groupby(level="code")` æˆ– `groupby(level="date")`
- é¿å…æœªæ¥å‡½æ•°ï¼šä¸è¦ä½¿ç”¨æœªæ¥æ•°æ®

#### æ­¥éª¤ 3ï¼šè¯„ä»·å› å­

```python
# å¤šå‘¨æœŸè¯„ä»·
reports = evaluator_engine.evaluate_multi_horizons(
    df=df,
    factor=factor_engine.compute_one(df, factor_name),
    horizons=[1, 5, 10, 20],  # æŒæœ‰æœŸåˆ—è¡¨
    evaluator="common_eval"
)

# æŸ¥çœ‹è¯„ä»·ç»“æœ
for horizon, report in reports.items():
    print(f"=== æŒæœ‰æœŸ: {horizon} å¤© ===")
    print(f"Rank IC: {report.metrics['rank_ic_mean']:.4f}")
    print(f"Rank IR: {report.metrics['rank_ic_ir']:.4f}")
    print(f"å¤šç©ºæ”¶ç›Š: {report.metrics['group_ls_mean']:.4f}")
    print(f"æ¢æ‰‹ç‡: {report.metrics['top_turnover_20_mean']:.4f}")
    
    # ç»˜åˆ¶å›¾è¡¨
    report.plot_artifacts(show_fig=True)
```

**è¯„ä»·æŒ‡æ ‡è¯´æ˜**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å¥½çš„æ ‡å‡† |
|------|------|----------|
| `rank_ic_mean` | Rank IC å‡å€¼ | ç»å¯¹å€¼ > 0.02 |
| `rank_ic_ir` | Rank IC IRï¼ˆä¿¡æ¯æ¯”ç‡ï¼‰ | ç»å¯¹å€¼ > 0.4 |
| `group_ls_mean` | å¤šç©ºç»„åˆæ”¶ç›Š | è¶Šå¤§è¶Šå¥½ |
| `top_turnover_20_mean` | Top 20% æ¢æ‰‹ç‡ | ç›¸å¯¹äºå‘¨æœŸ < 0.6 |
| `monotonic_mean` | æ”¶ç›Šå•è°ƒæ€§ | ç»å¯¹å€¼ > 0.1 |

#### æ­¥éª¤ 4ï¼šæ‰‹åŠ¨å…¥åº“å› å­

å¦‚æœå› å­è¡¨ç°è‰¯å¥½ï¼Œå¯ä»¥æ‰‹åŠ¨å…¥åº“ï¼š

```python
from app import get_factor_library
from factor_engine import get_factor

# è·å–å› å­åº“å®ä¾‹
factor_lib = get_factor_library()

# æ‰‹åŠ¨å…¥åº“ï¼ˆä¼šè‡ªåŠ¨ä¿å­˜åˆ° manual_storeï¼‰
factor_lib.manual_admit(
    spec=get_factor(factor_name),
    description="æˆ‘çš„åŠ¨é‡å› å­ - 20æ—¥æ”¶ç›Šç‡",
    tags=["momentum", "medium_term", "custom"]
)

print(f"âœ“ å› å­ '{factor_name}' å·²å…¥åº“åˆ° Manual Store")
```

#### æ­¥éª¤ 5ï¼šäº¤äº’å¼æŸ¥çœ‹ï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨ ipywidgets äº¤äº’å¼æŸ¥çœ‹ä¸åŒå‘¨æœŸçš„è¯„ä»·ç»“æœï¼š

```python
import json
import ipywidgets as widgets
from ipywidgets import interact
import matplotlib.pyplot as plt

def show_report(h):
    plt.close('all')
    report = reports[h]
    print(f"=== æŒæœ‰æœŸ: {h} å¤© ===")
    print(json.dumps(report.metrics, indent=4))
    report.plot_artifacts(show_fig=True)

interact(
    show_report,
    h=widgets.Dropdown(
        options=sorted(reports.keys()),
        description="Horizon",
    )
)
```

---

### æ–¹å¼äºŒï¼šè‡ªåŠ¨æ‰¹é‡æŒ–å› å­

ä½¿ç”¨ `auto_batch.py` æ‰¹é‡å¤„ç†å€™é€‰å› å­ï¼Œè‡ªåŠ¨è¯„ä»·å¹¶æ ¹æ®è§„åˆ™å…¥åº“ã€‚

#### æ­¥éª¤ 1ï¼šå®šä¹‰å€™é€‰å› å­

åœ¨ `factors/auto.py` ä¸­å®šä¹‰å¾…è¯„ä»·çš„å› å­ï¼š

```python
"""
è‡ªåŠ¨æŒ–æ˜çš„å› å­ï¼ˆå¾…è¯„ä»·å…¥åº“ï¼‰
æ‰€æœ‰åœ¨è¿™é‡Œæ³¨å†Œçš„å› å­ä¼šè¢« auto_batch.py è‡ªåŠ¨è¯„ä»·å¹¶åˆ¤æ–­æ˜¯å¦å…¥åº“
"""

import pandas as pd
import numpy as np
from factor_engine import register_factor

@register_factor(
    name="momentum_5d",
    required_fields=["close"],
    version="v1"
)
def momentum_5d(df: pd.DataFrame) -> pd.Series:
    """5æ—¥åŠ¨é‡å› å­"""
    return df.groupby(level="code")["close"].pct_change(5)

@register_factor(
    name="momentum_10d",
    required_fields=["close"],
    version="v1"
)
def momentum_10d(df: pd.DataFrame) -> pd.Series:
    """10æ—¥åŠ¨é‡å› å­"""
    return df.groupby(level="code")["close"].pct_change(10)

@register_factor(
    name="volatility_20d",
    required_fields=["close"],
    version="v1"
)
def volatility_20d(df: pd.DataFrame) -> pd.Series:
    """20æ—¥æ³¢åŠ¨ç‡å› å­"""
    return (df.groupby(level="code")["close"]
            .pct_change()
            .rolling(20)
            .std())

# ... æ·»åŠ æ›´å¤šå› å­
```

#### æ­¥éª¤ 2ï¼šè¿è¡Œè‡ªåŠ¨æ‰¹é‡å…¥åº“

```bash
python auto_batch.py
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. åŠ è½½ `factors/auto.py` ä¸­å®šä¹‰çš„æ‰€æœ‰å› å­
2. è®¡ç®—æ¯ä¸ªå› å­çš„å€¼
3. åœ¨å¤šä¸ªæŒæœ‰æœŸï¼ˆ1ã€5ã€10ã€20æ—¥ï¼‰ä¸Šè¯„ä»·å› å­
4. æ ¹æ®å…¥åº“è§„åˆ™è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å…¥åº“åˆ° `auto_store`
5. è¾“å‡ºè¯¦ç»†çš„è¯„ä»·æŠ¥å‘Š

**è¿è¡Œç¤ºä¾‹è¾“å‡º**ï¼š

```
================================================================================
åˆå§‹åŒ–è‡ªåŠ¨å› å­å¤„ç†å™¨
================================================================================

åŠ è½½æ•°æ®: ./data/daily_price.parquet
âœ“ æ•°æ®åŠ è½½å®Œæˆ: 150000 è¡Œ
âœ“ å› å­åº“åˆå§‹åŒ–å®Œæˆ
  - å…¥åº“è§„åˆ™: |IC| >= 0.02, |IR| >= 0.4, æ¢æ‰‹ç‡/å‘¨æœŸ <= 0.6, |å•è°ƒæ€§| >= 0.1
  - è¯„ä»·å‘¨æœŸ: [1, 5, 10, 20]

æ‰¾åˆ° 3 ä¸ªå·²æ³¨å†Œå› å­
  - å·²å…¥åº“: 0 ä¸ª
  - å¾…å¤„ç†: 3 ä¸ª

################################################################################
# è¿›åº¦: 1/3
################################################################################
================================================================================
å¤„ç†å› å­: momentum_5d (v1)
================================================================================
  [1/2] è®¡ç®—å› å­å€¼...
        âœ“ è®¡ç®—å®Œæˆ (éç©ºå€¼: 148500)
  [2/2] è¯„ä»·å› å­è¡¨ç°...
        âœ“ è¯„ä»·å®Œæˆ

  [è¯„ä»·æ‘˜è¦]
    å‘¨æœŸ |    Rank IC |     IC IR |   å¤šç©ºæ”¶ç›Š |     æ¢æ‰‹ç‡
  -----------------------------------------------------------------
     1æ—¥ |     0.0234 |     0.5234 |     0.0012 |     0.4521
     5æ—¥ |     0.0312 |     0.6123 |     0.0056 |     0.5234
    10æ—¥ |     0.0287 |     0.5876 |     0.0089 |     0.5876
    20æ—¥ |     0.0198 |     0.4234 |     0.0134 |     0.6234

  [å…¥åº“åˆ¤æ–­] æ£€æŸ¥å„å‘¨æœŸè¯„ä»·ç»“æœ
        -  1æ—¥: Rank IC= 0.0234, IR= 0.5234, æ¢æ‰‹ç‡/å‘¨æœŸ= 0.4521, |å•è°ƒæ€§|= 0.2341  âœ“ é€šè¿‡
        
  [å…¥åº“å†³ç­–] ä½¿ç”¨ 1 æ—¥è¯„ä»·ç»“æœè¿›è¡Œå…¥åº“
        âœ“ å…¥åº“æˆåŠŸï¼

...

================================================================================
å¤„ç†å®Œæˆ
================================================================================
  - æ€»å…±å¤„ç†: 3 ä¸ªå› å­
  - æˆåŠŸå…¥åº“: 2 ä¸ª
  - æœªé€šè¿‡: 1 ä¸ª

å½“å‰å› å­åº“ç»Ÿè®¡:
  - æ‰‹åŠ¨å…¥åº“: 0 ä¸ª
  - è‡ªåŠ¨å…¥åº“: 2 ä¸ª
  - æ€»è®¡: 2 ä¸ª
```

#### è‡ªåŠ¨å…¥åº“è§„åˆ™

å› å­éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼ˆä»»ä¸€å‘¨æœŸé€šè¿‡å³å¯ï¼‰ï¼š

```python
# åœ¨ config.yaml ä¸­é…ç½®
admission:
  min_rank_ic: 0.02              # |Rank IC| >= 0.02
  min_rank_ic_ir: 0.4            # |Rank IC IR| >= 0.4
  max_top_turnover_20_mean: 0.6  # æ¢æ‰‹ç‡/å‘¨æœŸ <= 0.6
  min_monotonic_mean: 0.1        # |æ”¶ç›Šå•è°ƒæ€§| >= 0.1
```

**é€»è¾‘**ï¼š
- è„šæœ¬ä¼šæŒ‰ä»çŸ­åˆ°é•¿çš„é¡ºåºæ£€æŸ¥æ¯ä¸ªå‘¨æœŸï¼ˆ1æ—¥ â†’ 5æ—¥ â†’ 10æ—¥ â†’ 20æ—¥ï¼‰
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ‰€æœ‰æ¡ä»¶çš„å‘¨æœŸï¼Œä½¿ç”¨è¯¥å‘¨æœŸçš„è¯„ä»·ç»“æœå…¥åº“
- å¦‚æœæ‰€æœ‰å‘¨æœŸéƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä¸å…¥åº“

---

## ğŸ“š å› å­åº“ç®¡ç†

### æŸ¥çœ‹å› å­åº“

```python
from app import get_factor_library

# è·å–å› å­åº“å®ä¾‹
lib = get_factor_library()

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
stats = lib.get_factor_count()
print(f"æ‰‹åŠ¨å…¥åº“: {stats['manual']} ä¸ª")
print(f"è‡ªåŠ¨å…¥åº“: {stats['auto']} ä¸ª")
print(f"æ€»è®¡: {stats['total']} ä¸ª")

# åˆ—å‡ºæ‰€æœ‰æ‰‹åŠ¨å…¥åº“å› å­
print("\n=== Manual Store ===")
for entry in lib.manual_store.list_entries():
    print(f"- {entry.spec.name} ({entry.spec.version})")
    print(f"  æè¿°: {entry.description}")
    print(f"  æ ‡ç­¾: {entry.tags}")
    print(f"  æ—¶é—´: {entry.created_at}")
    print()

# åˆ—å‡ºæ‰€æœ‰è‡ªåŠ¨å…¥åº“å› å­
print("=== Auto Store ===")
for entry in lib.auto_store.list_entries():
    print(f"- {entry.spec.name} ({entry.spec.version})")
    print(f"  æè¿°: {entry.description}")
    print(f"  è¯„ä»·æŒ‡æ ‡: Rank IC={entry.eval_metrics.get('rank_ic_mean', 0):.4f}")
    print()
```

### ä½¿ç”¨å·²å…¥åº“å› å­

```python
from app import get_factor_library
from data_manager import LoacalDatasource

# åŠ è½½æ•°æ®
datasource = LoacalDatasource(file_path="./data/daily_price.parquet")
df = datasource.load_data(start="2020-01-01", end="2026-01-01")

# è·å–å› å­åº“
lib = get_factor_library()

# ä»å› å­åº“è®¡ç®—å› å­
factor = lib.compute_factor(
    df=df,
    name="momentum_5d",
    version="v1"
)

print(factor.head())
```

### è·å–å› å­è¯„ä»·æŠ¥å‘Š

```python
# ä¸ºå·²å…¥åº“å› å­ç”Ÿæˆæ–°çš„è¯„ä»·æŠ¥å‘Š
reports = lib.get_factor_report(
    df=df,
    name="momentum_5d",
    horizons=[1, 5, 10, 20],
    evaluator_name="common_eval",
    version="v1"
)

# æŸ¥çœ‹æŠ¥å‘Š
for horizon, report in reports.items():
    print(f"å‘¨æœŸ {horizon}: IC={report.metrics['rank_ic_mean']:.4f}")
```

### åˆ é™¤å› å­

```python
# ä» manual_store åˆ é™¤
lib.manual_store.delete_entry(name="my_factor", version="v1")

# ä» auto_store åˆ é™¤
lib.auto_store.delete_entry(name="momentum_5d", version="v1")

print("âœ“ å› å­å·²åˆ é™¤")
```

### æ‰¹é‡æ‰‹åŠ¨å…¥åº“

ä½¿ç”¨ `manual_batch.py` æ‰¹é‡å°†æ‰‹åŠ¨æŒ–æ˜çš„å› å­å…¥åº“ï¼š

```python
# 1. åœ¨ factors/manual.py ä¸­å®šä¹‰å› å­
# 2. è¿è¡Œæ‰¹é‡å…¥åº“è„šæœ¬
```

```bash
python manual_batch.py
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### config.yaml

å®Œæ•´çš„é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼š

```yaml
# å­˜å‚¨é…ç½®
storage:
  base_dir: "./factor_store"      # å› å­åº“æ ¹ç›®å½•
  manual_dir: "manual"             # æ‰‹åŠ¨å…¥åº“å­ç›®å½•
  auto_dir: "auto"                 # è‡ªåŠ¨å…¥åº“å­ç›®å½•

# å…¥åº“è§„åˆ™é…ç½®
admission:
  # å› å­å…¥åº“çš„æœ€å° Rank IC å‡å€¼ï¼ˆç»å¯¹å€¼ï¼‰
  min_rank_ic: 0.02
  
  # å› å­å…¥åº“çš„æœ€å° Rank IC IRï¼ˆç»å¯¹å€¼ï¼‰
  min_rank_ic_ir: 0.4
  
  # å› å­å…¥åº“çš„æœ€å¤§æ¢æ‰‹ç‡ï¼ˆç›¸å¯¹äºæŒæœ‰æœŸï¼‰
  # ä¾‹å¦‚ï¼šå‘¨æœŸä¸º 5 æ—¥ï¼Œæ¢æ‰‹ç‡ä¸º 3.0ï¼Œåˆ™ç›¸å¯¹æ¢æ‰‹ç‡ä¸º 3.0/5=0.6
  max_top_turnover_20_mean: 0.6
  
  # å› å­å…¥åº“çš„æœ€å°æ”¶ç›Šå•è°ƒæ€§ï¼ˆç»å¯¹å€¼ï¼‰
  # è¡¡é‡å› å­åˆ†ç»„æ”¶ç›Šçš„å•è°ƒæ€§
  min_monotonic_mean: 0.1
```

**å‚æ•°è°ƒä¼˜å»ºè®®**ï¼š

- **å®½æ¾è§„åˆ™**ï¼šé™ä½ `min_rank_ic` å’Œ `min_rank_ic_ir`ï¼Œæ”¾å®½ `max_top_turnover_20_mean`
  - é€‚åˆï¼šæ¢ç´¢é˜¶æ®µï¼Œå¸Œæœ›å…¥åº“æ›´å¤šå€™é€‰å› å­
  
- **ä¸¥æ ¼è§„åˆ™**ï¼šæé«˜æ‰€æœ‰é˜ˆå€¼
  - é€‚åˆï¼šç”Ÿäº§ç¯å¢ƒï¼Œåªä¿ç•™é«˜è´¨é‡å› å­

### å­˜å‚¨ç›®å½•ç»“æ„

```
factor_store/
â”œâ”€â”€ manual/                      # æ‰‹åŠ¨å…¥åº“çš„å› å­
â”‚   â””â”€â”€ liquidity_momentum_deviation_v1/
â”‚       â”œâ”€â”€ meta.json           # å› å­å…ƒæ•°æ®
â”‚       â””â”€â”€ func.pkl            # å› å­å‡½æ•°å¯¹è±¡ï¼ˆpickleï¼‰
â””â”€â”€ auto/                        # è‡ªåŠ¨å…¥åº“çš„å› å­
    â”œâ”€â”€ momentum_5d_v1/
    â”‚   â”œâ”€â”€ meta.json
    â”‚   â””â”€â”€ func.pkl
    â””â”€â”€ momentum_10d_v1/
        â”œâ”€â”€ meta.json
        â””â”€â”€ func.pkl
```

**meta.json ç¤ºä¾‹**ï¼š

```json
{
    "name": "momentum_5d",
    "version": "v1",
    "description": "5æ—¥åŠ¨é‡å› å­",
    "tags": ["momentum", "short_term"],
    "source": "auto",
    "created_at": "2025-11-26T10:30:00",
    "required_fields": ["close"],
    "eval_metrics": {
        "rank_ic_mean": 0.0234,
        "rank_ic_ir": 0.5234,
        "group_ls_mean": 0.0012,
        "top_turnover_20_mean": 0.4521
    },
    "eval_horizon": 1
}
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
FactorFramework/
â”œâ”€â”€ config.yaml                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ app.py                       # åº”ç”¨å…¥å£ï¼Œä¾èµ–æ³¨å…¥
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ analysis.ipynb               # äº¤äº’å¼å› å­åˆ†æï¼ˆæ¨èï¼‰
â”œâ”€â”€ manual.ipynb                 # æ‰‹åŠ¨å…¥åº“æ“ä½œç¤ºä¾‹
â”œâ”€â”€ manual_batch.py              # æ‰¹é‡æ‰‹åŠ¨å…¥åº“è„šæœ¬
â”œâ”€â”€ auto_batch.py                # è‡ªåŠ¨æ‰¹é‡å…¥åº“è„šæœ¬
â”‚
â”œâ”€â”€ data/                        # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ daily_price.parquet     # æ—¥é¢‘è¡Œæƒ…æ•°æ®
â”‚
â”œâ”€â”€ factor_store/                # å› å­åº“å­˜å‚¨
â”‚   â”œâ”€â”€ manual/                 # æ‰‹åŠ¨å…¥åº“å› å­
â”‚   â””â”€â”€ auto/                   # è‡ªåŠ¨å…¥åº“å› å­
â”‚
â”œâ”€â”€ factors/                     # å› å­å®šä¹‰
â”‚   â”œâ”€â”€ manual.py               # æ‰‹åŠ¨æŒ–æ˜çš„å› å­
â”‚   â””â”€â”€ auto.py                 # å¾…è‡ªåŠ¨è¯„ä»·çš„å› å­
â”‚
â”œâ”€â”€ data_manager/                # æ•°æ®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ interfaces.py           # æ•°æ®æºæ¥å£
â”‚   â””â”€â”€ datasource.py           # æœ¬åœ°æ•°æ®æºå®ç°
â”‚
â”œâ”€â”€ factor_engine/               # å› å­å¼•æ“æ¨¡å—
â”‚   â”œâ”€â”€ interfaces.py           # å› å­æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ registry.py             # å› å­æ³¨å†Œè¡¨
â”‚   â””â”€â”€ engine.py               # å› å­è®¡ç®—å¼•æ“
â”‚
â”œâ”€â”€ evaluation/                  # è¯„ä»·å¼•æ“æ¨¡å—
â”‚   â”œâ”€â”€ interfaces.py           # è¯„ä»·å™¨æ¥å£
â”‚   â”œâ”€â”€ registry.py             # è¯„ä»·å™¨æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ forward_return.py       # æœªæ¥æ”¶ç›Šè®¡ç®—
â”‚   â”œâ”€â”€ builtins.py             # å†…ç½®è¯„ä»·å™¨
â”‚   â””â”€â”€ engine.py               # è¯„ä»·å¼•æ“
â”‚
â””â”€â”€ factor_library/              # å› å­åº“æ¨¡å—
    â”œâ”€â”€ interfaces.py           # å› å­åº“æ¥å£
    â”œâ”€â”€ storage.py              # å› å­å­˜å‚¨å®ç°
    â”œâ”€â”€ admission.py            # å…¥åº“è§„åˆ™
    â”œâ”€â”€ service.py              # å› å­åº“æœåŠ¡
    â”œâ”€â”€ README.md               # æ¨¡å—è¯¦ç»†æ–‡æ¡£
    â””â”€â”€ USAGE.md                # ä½¿ç”¨æŒ‡å—
```

---

## ğŸ“¦ ä¾èµ–å®‰è£…

### å¿…éœ€ä¾èµ–

```bash
pip install pandas numpy scipy matplotlib pyyaml
```

### å¯é€‰ä¾èµ–

```bash
# äº¤äº’å¼ Notebook æ”¯æŒ
pip install ipywidgets jupyter

# æ•°æ®å¤„ç†åŠ é€Ÿ
pip install pyarrow fastparquet
```

### å®Œæ•´å®‰è£…

```bash
pip install pandas numpy scipy matplotlib pyyaml ipywidgets jupyter pyarrow
```

---

## ğŸ“– ä½¿ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šåŠ¨é‡å› å­æŒ–æ˜

```python
# åœ¨ analysis.ipynb ä¸­

# 1. å®šä¹‰å› å­
@register_factor(name="momentum_20d", required_fields=["close"])
def momentum_20d(df):
    return df.groupby(level="code")["close"].pct_change(20)

# 2. è¯„ä»·å› å­
reports = evaluator_engine.evaluate_multi_horizons(
    df=df,
    factor=factor_engine.compute_one(df, "momentum_20d"),
    horizons=[1, 5, 10, 20]
)

# 3. æŸ¥çœ‹ç»“æœå¹¶å†³å®šæ˜¯å¦å…¥åº“
# å¦‚æœè¡¨ç°è‰¯å¥½ï¼Œæ‰‹åŠ¨å…¥åº“
factor_lib.manual_admit(spec=get_factor("momentum_20d"))
```

### æ¡ˆä¾‹ 2ï¼šå¤åˆå› å­

```python
@register_factor(
    name="liquidity_momentum_deviation",
    required_fields=["open", "close", "amount"]
)
def liquidity_momentum_deviation(df):
    """æˆäº¤é¢åŠ æƒçš„åŠ¨é‡åç¦»åº¦"""
    def cal(g):
        mean = ((np.log(g["close"] / g["open"])) * g["amount"]).median()
        deviation = ((np.log(g["close"] / g["open"])) * g["amount"] - mean) ** 2
        return deviation
    
    factor = df.groupby("date").apply(cal)
    factor.index = factor.index.droplevel(0)
    return factor
```

### æ¡ˆä¾‹ 3ï¼šæ‰¹é‡å› å­æµ‹è¯•

```python
# åœ¨ factors/auto.py ä¸­å®šä¹‰å¤šä¸ªå› å­
# ç„¶åè¿è¡Œæ‰¹é‡è„šæœ¬

# Terminal:
$ python auto_batch.py

# è‡ªåŠ¨è¯„ä»·æ‰€æœ‰å› å­å¹¶æ ¹æ®è§„åˆ™å…¥åº“
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å› å­ç¼–å†™è§„èŒƒ

- **ç´¢å¼•å¯¹é½**ï¼šç¡®ä¿è¾“å‡º Series çš„ç´¢å¼•ä¸è¾“å…¥ DataFrame å¯¹é½
- **é¿å…æœªæ¥å‡½æ•°**ï¼šä¸è¦ä½¿ç”¨æœªæ¥æ•°æ®
- **å¤„ç†ç¼ºå¤±å€¼**ï¼šåˆç†å¤„ç† NaN å€¼
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å‘é‡åŒ–æ“ä½œï¼Œé¿å…å¾ªç¯

### 2. å› å­è¯„ä»·æµç¨‹

1. **å…ˆäº¤äº’å¼æµ‹è¯•**ï¼šä½¿ç”¨ `analysis.ipynb` å¿«é€ŸéªŒè¯å› å­é€»è¾‘
2. **å¤šå‘¨æœŸè¯„ä»·**ï¼šè‡³å°‘æµ‹è¯• 4 ä¸ªä¸åŒæŒæœ‰æœŸï¼ˆ1ã€5ã€10ã€20æ—¥ï¼‰
3. **æŸ¥çœ‹å¯è§†åŒ–**ï¼šä¸ä»…çœ‹æ•°å€¼æŒ‡æ ‡ï¼Œè¿˜è¦çœ‹ IC æ—¶åºå›¾ã€åˆ†ç»„æ”¶ç›Šå›¾
4. **ç»¼åˆåˆ¤æ–­**ï¼šä¸ä»…çœ‹ IC/IRï¼Œè¿˜è¦è€ƒè™‘æ¢æ‰‹ç‡ã€å•è°ƒæ€§ã€ç¨³å®šæ€§

### 3. å› å­ç®¡ç†ç­–ç•¥

- **Manual Store**ï¼šç²¾é€‰é«˜è´¨é‡å› å­ï¼Œæ‰‹åŠ¨å®¡æ ¸åå…¥åº“
- **Auto Store**ï¼šæ‰¹é‡ç­›é€‰çš„å› å­ï¼Œå®šæœŸå›é¡¾å’Œæ¸…ç†
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šé‡è¦ä¿®æ”¹ä½¿ç”¨æ–°ç‰ˆæœ¬å·ï¼Œä¿ç•™å†å²ç‰ˆæœ¬
- **æ ‡ç­¾åˆ†ç±»**ï¼šä½¿ç”¨æ ‡ç­¾ç»„ç»‡å› å­ï¼Œå¦‚ `["momentum", "short_term"]`

### 4. é…ç½®è°ƒä¼˜

- **æ¢ç´¢é˜¶æ®µ**ï¼šä½¿ç”¨å®½æ¾è§„åˆ™ï¼Œå…¥åº“æ›´å¤šå€™é€‰å› å­
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ä¸¥æ ¼è§„åˆ™ï¼Œåªä¿ç•™é«˜è´¨é‡å› å­
- **å®šæœŸå›æµ‹**ï¼šå®šæœŸå¯¹å·²å…¥åº“å› å­è¿›è¡Œå›æµ‹éªŒè¯

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1ï¼šå¦‚ä½•å¤„ç†å› å­è®¡ç®—ä¸­çš„å¼‚å¸¸ï¼Ÿ

```python
try:
    factor = factor_engine.compute_one(df, factor_name)
except Exception as e:
    print(f"å› å­è®¡ç®—å¤±è´¥: {e}")
    # æ£€æŸ¥å› å­å®šä¹‰å’Œæ•°æ®
```

### Q2ï¼šå¦‚ä½•è‡ªå®šä¹‰å…¥åº“è§„åˆ™ï¼Ÿ

```python
from factor_library import AdmissionRule

# åˆ›å»ºè‡ªå®šä¹‰è§„åˆ™
custom_rule = AdmissionRule(
    min_rank_ic=0.03,        # æ›´ä¸¥æ ¼çš„ IC è¦æ±‚
    min_rank_ic_ir=0.6,      # æ›´ä¸¥æ ¼çš„ IR è¦æ±‚
    max_top_turnover_20_mean=0.5,  # æ›´ä½çš„æ¢æ‰‹ç‡
    min_monotonic_mean=0.15  # æ›´é«˜çš„å•è°ƒæ€§
)

# ä½¿ç”¨è‡ªå®šä¹‰è§„åˆ™åˆ›å»ºå› å­åº“
from factor_library import FactorLibrary, FactorStore
from factor_engine import FactorEngine
from evaluation import EvaluatorEngine

lib = FactorLibrary(
    manual_store=FactorStore(...),
    auto_store=FactorStore(...),
    factor_engine=FactorEngine(),
    evaluator_engine=EvaluatorEngine(),
    admission_rule=custom_rule  # ä½¿ç”¨è‡ªå®šä¹‰è§„åˆ™
)
```

### Q3ï¼šå¦‚ä½•æ‰¹é‡è®¡ç®—å¤šä¸ªå› å­ï¼Ÿ

```python
# æ–¹æ³•1ï¼šä½¿ç”¨ FactorEngine
factor_dict = {}
for name in ["momentum_5d", "momentum_10d", "momentum_20d"]:
    factor_dict[name] = factor_engine.compute_one(df, name)

# æ–¹æ³•2ï¼šä»å› å­åº“æ‰¹é‡è®¡ç®—
lib = get_factor_library()
entries = lib.manual_store.list_entries()

for entry in entries:
    factor = lib.compute_factor(df, entry.spec.name, entry.spec.version)
    print(f"{entry.spec.name}: è®¡ç®—å®Œæˆ")
```

### Q4ï¼šå¦‚ä½•å¯¼å‡ºå› å­æ•°æ®ï¼Ÿ

```python
# è®¡ç®—å› å­
factor = lib.compute_factor(df, name="momentum_5d")

# å¯¼å‡ºä¸º CSV
factor.to_csv("factor_momentum_5d.csv")

# å¯¼å‡ºä¸º Parquet
factor.to_frame(name="factor_value").to_parquet("factor_momentum_5d.parquet")
```

---

## ğŸ“ è”ç³»ä¸è´¡çŒ®

- **ä½œè€…**ï¼šxb1002
- **é¡¹ç›®**ï¼šFactorFrameworkV2
- **åˆ†æ”¯**ï¼šdev

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**Happy Factor Mining! ğŸš€**
